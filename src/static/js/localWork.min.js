$(function(){function totalScore(){var s=0;$.each($(".t-stat-li"),function(){s+=Number($(this).find("i").text())}),$(".t-stat-score-total p").text(s.toFixed(2))}for(var cookiesArr=document.cookie.split(";"),i=0;i<cookiesArr.length;i++)if(-1!=cookiesArr[i].indexOf("user"))var user=cookiesArr[i].split("="),userInfo=JSON.parse(decodeURIComponent(user[1])),tid=userInfo.tid,token="?token="+userInfo.token;var hash=window.location.hash.split("/"),pid=hash[hash.length-1];$(".mtk-contenter").on("focus","input",function(){$(this).blur()}),$(".mtk-contenter").on("focus","div",function(){$(this).blur()}),$(".left-input").on("click","span",function(ev){ev.stopPropagation(),$element=$(this).parent().parent().parent();for(var qtype=$element.attr("data-type"),content=$element.find(".title").html(),resolve={},analysis=$element.find(".analysis"),k=0;k<analysis.length;k++){var key=$(analysis[k]).find(".analysis-li1 input").val(),value=$(analysis[k]).find(".analysis-li3").html();resolve[key]=value}if(1==qtype){for(var score=$element.find('input[attr="score"]').val(),choices=[],answer=[],answerList=$element.find(".answer-li"),i=0;i<answerList.length;i++){var choice=$(answerList[i]).find(".answer").html();if(choices.push(choice),$(answerList[i]).find(".choice").hasClass("correct")){var index=$(answerList[i]).index();answer.push(index)}}$.ajax({type:"PUT",contentType:"application/json",url:"http://115.29.177.200/mstudy/question"+token,data:JSON.stringify({pid:parseInt(pid),qtype:parseInt(qtype),tid:parseInt(tid),answer:answer,content:content,choices:choices,resolve:resolve,score:parseInt(score)}),success:function(data){if(1==data.ret){var html="<div class='ui-sortable-handle'><dt data-type='1' qid="+data.con.qid+"></dt></div>";html=$(html).find("dt").append($element.html()).end(),$(".pinput-dl").append(html),$(".pinput-dl").find("dt").last().find(".pinput-item-opt span").replaceWith('<a class="del" href="javascript:;"></a><a class="show" href="javascript:;"></a>');var qIndex=$(".pinput-dl").find("dt").length;$(".pinput-dl").find("dt").last().find("span.tit").text($(".pinput-dl").find("dt").length+".");var oLi='<li class="t-stat-li" tit="'+qIndex+'"><span class="t-stat-tit fl">'+qIndex+'. </span><span class="t-stat-score fl"><i>'+score+"</i>分</span></li>";$(".t-stat .scroll").append(oLi),totalScore();var top=$(".pinput-dl").find("dt").last().offset().top;$("body").animate({scrollTop:top},800)}}})}if(2==qtype){var score=$element.find(".pinput-problem-info input").val(),choices=[];choices[0]=[],choices[1]=[];for(var answerList=$element.find(".answer-li"),i=0;i<answerList.length;i++){var itemType=$(answerList[i]).find(".reply").attr("item-type");itemType=parseInt(itemType),choices[0].push(itemType);var sscore=$(answerList[i]).find("input").val();sscore=parseFloat(sscore),choices[1].push(sscore)}$.ajax({type:"PUT",contentType:"application/json",url:"http://115.29.177.200/mstudy/question"+token,data:JSON.stringify({pid:parseInt(pid),qtype:parseInt(qtype),tid:parseInt(tid),content:content,choices:choices,resolve:resolve,score:parseInt(score)}),success:function(data){if(1==data.ret){var html="<div class='ui-sortable-handle'><dt data-type='2' qid="+data.con.qid+"></dt></div>";html=$(html).find("dt").append($element.html()).end(),$(".pinput-dl").append(html),$(".pinput-dl").find("dt").last().find(".pinput-item-opt span").replaceWith('<a class="del" href="javascript:;"></a><a class="show" href="javascript:;"></a>');var qIndex=$(".pinput-dl").find("dt").length;$(".pinput-dl").find("dt").last().find("span.tit").text($(".pinput-dl").find("dt").length+".");var oLi='<li class="t-stat-li" tit="'+qIndex+'"><span class="t-stat-tit fl">'+qIndex+'. </span><span class="t-stat-score fl"><i>'+score+"</i>分</span></li>";$(".t-stat .scroll").append(oLi),totalScore();var top=$(".pinput-dl").find("dt").last().offset().top;$("body").animate({scrollTop:top},800)}else alert("添加失败!")}})}if(3==qtype){var content=$element.find('div[attr="material"]').html();$.ajax({type:"PUT",contentType:"application/json",url:"http://115.29.177.200/mstudy/stem"+token,data:JSON.stringify({pid:parseInt(pid),tid:parseInt(tid),content:content}),success:function(data){var qsid=data.con.qsid;if(1==data.ret){$ele=$element.find(".pinput-question");var html="<div class='ui-sortable-handle'><dt data-type='3' qsid="+data.con.qsid+"></dt></div>";$dt=$(html).find("dt").append($element.html()).end(),$(".pinput-dl").append($dt),$(".pinput-dl").find("dt").last().find(".pinput-item-opt span").replaceWith('<a class="del" href="javascript:;"></a><a class="show" href="javascript:;"></a>');var qIndex=$(".pinput-dl").find("dt").length;$(".pinput-dl").find("dt").last().find(".pinput-item span.tit").text(qIndex+".");var $stit=$(".pinput-dl").find("dt").last().find(".pinput-question");totalScore();for(var j=0;j<$ele.length;j++){for(var $target=$($ele[j]),stype=$target.attr("data-type"),score=$target.find(".score input").val(),content=$target.find('div[attr="title"]').html(),resolve={},analysis=$target.find(".analysis"),resolve={},k=0;k<analysis.length;k++){var key=$(analysis[k]).find(".analysis-li1 input").val(),value=$(analysis[k]).find(".analysis-li3").html();resolve[key]=value}var sIndex=0;if(1==stype){for(var choices=[],answer=[],answerList=$target.find(".answer-li"),i=0;i<answerList.length;i++){var choice=$(answerList[i]).find(".answer").html();if(choices.push(choice),$(answerList[i]).find(".choice").hasClass("correct")){var index=$(answerList[i]).index();answer.push(index)}}$.ajax({type:"PUT",contentType:"application/json",url:"http://115.29.177.200/mstudy/question/item"+token,data:JSON.stringify({pid:parseInt(pid),qtype:parseInt(stype),tid:parseInt(tid),qsid:qsid,answer:answer,content:content,choices:choices,resolve:resolve,score:parseInt(score)}),success:function(data){if(1==data.ret){sIndex++,$stit.eq(sIndex-1).find(".pinput-problem-info .tit").text(qIndex+"-"+sIndex+".");var oLi='<li class="t-stat-li" tit="'+qIndex+"-"+j+'"><span class="t-stat-tit fl">'+qIndex+"-"+sIndex+'. </span><span class="t-stat-score fl"><i>'+score+"</i>分</span></li>";$(".t-stat .scroll").append(oLi);var top=$(".pinput-dl").find("dt").last().offset().top;$("body").animate({scrollTop:top},800)}}})}if(2==stype){var choices=[];choices[0]=[],choices[1]=[];for(var answerList=$target.find(".answer-li"),i=0;i<answerList.length;i++){var itemType=$(answerList[i]).find(".reply").attr("item-type");itemType=parseInt(itemType),choices[0].push(itemType);var sscore=$(answerList[i]).find("input").val();sscore=parseInt(sscore),choices[1].push(sscore)}$.ajax({type:"PUT",contentType:"application/json",url:"http://115.29.177.200/mstudy/question/item"+token,data:JSON.stringify({pid:parseInt(pid),qtype:parseInt(stype),tid:parseInt(tid),qsid:qsid,content:content,choices:choices,resolve:resolve}),success:function(data){if(1==data.ret){sIndex++,$stit.eq(sIndex-1).find(".pinput-problem-info .tit").text(qIndex+"-"+sIndex+".");var oLi='<li class="t-stat-li" tit="'+qIndex+"-"+j+'"><span class="t-stat-tit fl">'+qIndex+"-"+sIndex+'. </span><span class="t-stat-score fl"><i>'+score+"</i>分</span></li>";$(".t-stat .scroll").append(oLi);var top=$(".pinput-dl").find("dt").last().offset().top;$("body").animate({scrollTop:top},800)}else alert("添加失败!")}})}}}}})}}),$(".left-input").on("click",".pinput-item-slide",function(){var $dt=$(this).parents("dt");$dt.toggleClass("sort"),$dt.find(".pinput-item-slide").toggleClass("pinput-item-slide-a"),$dt.find(".pinput-item-main").toggle(),$dt.find(".pinput-item-opt").toggle()}),$(".paperName .toggle").on("click",function(){"收起"==$(".paperName .toggle").text().trim()?($(".left-input").find(".pinput-item-slide").addClass("pinput-item-slide-a"),$(".left-input").find(".pinput-item-main").css("display","none"),$(".left-input").find(".pinput-item-opt").css("display","none"),$(".paperName .toggle").text("展开")):($(".left-input").find(".pinput-item-slide").removeClass("pinput-item-slide-a"),$(".left-input").find(".pinput-item-main").css("display","block"),$(".left-input").find(".pinput-item-opt").css("display","block"),$(".paperName .toggle").text("收起"))})});